# 分布式事务的六种方案
分布式事务的六种方案分别为：2PC，3PC， TCC, 本地消息表， 消息事务， 最大努力通知

分布式事务：在分布式系统中实现事务，由多个本地事务组合而成。

## 2PC
2PC也就是二阶段提交。二阶段提交是一种强一致性设计， 二阶段提交引入事务协调者的角色来协调管理各参与者的提交和回滚。

二阶段分别指的是准备（投票）和提交两个阶段。

准备阶段协调者会给各参与者发送准备命令，可以把准备命令理解成除了提交事务之外什么事情都做完。

假如在第一阶段所有参与者都返回准备成功，则事务协调者发送提交事务命令，然后等待所有事务都提交成功之后，返回事务执行成功。

假如在第一阶段中有参与者返回失败，则事务协调者就会向所有参与者发送回滚事务的请求，即分布式事务执行失败。

如果第二阶段提交阶段失败，不论是进行的回滚操作还是提交操作，都需要不断重试。

二阶段提交是一个同步阻塞协议，协调者会等待所有参与者都返回响应之后才会进行下一步操作，当然第一阶段的协调者有超时机制，假设因为网络原因没有收到参与者的响应或者参与者挂了，超时后就会判断失误失败，向所有参与者发送回滚命令。

## 3PC
3阶段提交，是二阶段提交的改进版本。

与二阶段提交不同的是，三阶段提交有两个改动点：
- 引入超时机制，同时在协调者和参与者中都引入超时机制。
- 在第一阶段和第二阶段中插入一个准备阶段，保证了最后提交阶段之前各参与节点的状态是一致的。

准备阶段并不会直接执行事务，而是会去询问此时的参与者是否有条件接这个事务，因此不会一来就锁资源，使得在某些资源不可用的情况下，所有参与者都阻塞着。

三阶段提交就有CanCommit、PreCommit、DoCommit三个阶段

## TCC
TCC分布式事务：TCC是服务化的两阶段编程事务，其Try、Confirm、Cancel，三个方法均由业务编码实现

TCC要求每个分支事务实现三个操作，预处理Try, 确认Confirm, 撤销Cancel

## 可靠消息最终一致性
可靠消息最终一致性就是保证消息从生产方经过消息中间件传递到消息方的一致性。

RocketMQ主要解决了两个功能：本地事务与消息发送的原子性问题。事务参与方接收消息的可靠性

可靠消息最终一致性事务适合执行周期长且实时性要求不高的场景，引入消息机制后，同步的事务操作变为基于消息执行的异步操作，避免分布式事务中的同步阻塞操作的影响，并实现了两个服务的解耦。

## 最大努力通知
最大努力通知和可靠消息一致性有什么不同：
- 可靠消息一致性，是需要发起通知方确保消息发送出去，通知的可靠性在于发送通知方
- 最大努力通知，发送通知方会尽最大努力通知接收通知方，但是消息可能会接收不到，接收通知方会主动调用发送通知方的接口进行查询，通知可靠性在于接收通知方。

基于MQ的ack机制实现最大努力通知：
- 利用MQ的ack机制由MQ向接收通知方发送消息通知，发起方将普通消息发送到MQ
- 接收通知监听MQ，接收消息，业务处理完成回应ACK
- 接收通知方没有回应ACK则MQ会重复通知，按照时间间隔的方式，逐步拉大通知间隔

https://zhuanlan.zhihu.com/p/100279671
