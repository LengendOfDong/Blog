# 延时队列
常用的Rabbitmq 和 kafka的使用很麻烦，对于只有一组消费者的情况，也需要经过很复杂的过程。

Redis对于那些只有一组消费者的消息队列，可以轻松搞定。

Redis的list(列表)数据结构常用来作为异步消息队列使用。用rpush和lpush操作入队列，用lpop 和 rpop操作出队列。

## 队列空了如何
如果队列空了，还在不断轮询就会造成CPU消耗，Redis的QPS也会被拉高。

通常使用sleep来解决这个问题：
```java
time.sleep(1)             //python 睡 1s
Thread.sleep(1000)        //java 睡 1s
```

## 阻塞读
sleep会导致消息的延迟增大，可以使用两个指令blpop/brpop

blpop/brpop的前缀字符b代表blocking, 即阻塞读

阻塞读在队列没有数据的时候，会立即进入休眠状态，一旦数据到来，则立刻醒过来。消息的延迟几乎为零。

## 空闲连接自动断开
如果线程一直阻塞在那里，那么Redis客户端连接就变成了闲置连接，服务器一般会主动断开连接，减少闲置资源占用，这个时候blpop/brpop就会抛出异常。

如果捕获到异常，还应该继续重试。

## 锁冲突
如果客户端在处理请求时加锁没有加成功怎么办，一般有如下3种策略来处理加锁失败。
- 直接抛出异常，通知用户稍后重试
  
  这种适合由用户直接发起的请求，本质上是对当前请求的放弃，由用户决定是否重新发起新的请求。
  
- sleep
  
  sleep会阻塞当前的消息处理线程，对于频繁的请求，并且要求消息的及时性，此时使用sleep并不合适。
- 延时队列

  这种方式适合异步消息处理，将当前冲突的请求扔到另一个队列延后处理。
  
