# 延时队列
常用的Rabbitmq 和 kafka的使用很麻烦，对于只有一组消费者的情况，也需要经过很复杂的过程。

Redis对于那些只有一组消费者的消息队列，可以轻松搞定。

Redis的list(列表)数据结构常用来作为异步消息队列使用。用rpush和lpush操作入队列，用lpop 和 rpop操作出队列。

## 队列空了如何
如果队列空了，还在不断轮询就会造成CPU消耗，Redis的QPS也会被拉高。

通常使用sleep来解决这个问题：
```java
time.sleep(1)             //python 睡 1s
Thread.sleep(1000)        //java 睡 1s
```

## 阻塞读
sleep会导致消息的延迟增大，可以使用两个指令blpop/brpop

blpop/brpop的前缀字符b代表blocking, 即阻塞读

阻塞读在队列没有数据的时候，会立即进入休眠状态，一旦数据到来，则立刻醒过来。消息的延迟几乎为零。

## 空闲连接自动断开
如果线程一直阻塞在那里，那么Redis客户端连接就变成了闲置连接，服务器一般会主动断开连接，减少闲置资源占用，这个时候blpop/brpop就会抛出异常。

如果捕获到异常，还应该继续重试。

