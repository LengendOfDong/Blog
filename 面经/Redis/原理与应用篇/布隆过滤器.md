# 布隆过滤器
Redis高级数据结构布隆过滤器（Bloom Filter

## 适用场景
使用客户端看新闻时，会给我们不停地推荐新的内容，而它每次推荐时都要去重，以去掉那些我们已经看过的内容，所以新闻客户端推荐系统需要实现推荐去重。

## 安装布隆过滤器
在使用brew安装redis之后，需要安装布隆过滤器的插件才可以使用布隆过滤器。
```shell
# 先进入到brew安装redis的路径中，再下载布隆过滤器插件。
[root]# cd /usr/local/Cellar/redis
[root]# wget "https://github.com/RedisBloom/RedisBloom/archive/v2.2.0.tar.gz"
[root]# tar zxvf v2.2.0.tar.gz 
[root]# cd  RedisBloom-2.2.0/
[root]# make
[root]# ll
-rwxr-xr-x 1 root root 331600 Mar 16 20:15 redisbloom.so

# 启动布隆过滤器
[root]# redis-server --loadmodule /usr/local/Cellar/redis/RedisBloom-1.1.1/rebloom.so
```
布隆过滤器有两个基本指令，bf.add和bf.exists，bf.add添加元素，bf.exists查询元素是否存在。
布隆过滤器的基本误判率在1%多一点。

可以使用自定义参数的布隆过滤器，需要在add前使用bf.reserve指令显式创建。bf.reserve有三个参数，分别是key/error_rate(错误率)/initial_rate,error_rate越低，需要的空间越大。

如果不使用bf.reserve，默认的error_rate是O.O1，默认的initial_size是100。

## 注意事项
用户在使用布隆过滤器之前需要尽可能地精确估计元素数量，还需要加上一定的冗余空间以避免实际元素可能会高出估计值很多。

对于精确度要求不高的场合，布隆过滤器的error_rate也可以设置大一点，比如之前提到的新闻客户端推送的情况，error_rate设置大点，只会让小部分文章不能让合适的人看到。

## 布隆过滤器的原理
每个布隆过滤器对应到Redis的数据结构里面就是一个大型的位数组和几个不一样的无偏hash函数，所谓无偏就是能够把元素的hash值算得比较均匀，让元素被hash映射到位数组中的位置比较随机。

向布隆过滤器中添加key时，多个hash函数会对key进行hash,算得一个整数值，并对位数组长度进行取模，此处需要注意的是如果添加的数量远大于位数组长度时，位数组中的位置就有可能是多个key对应的位置。

向布隆过滤器中询问key是否存在时，同样是多个hash函数对key进行hash,并查询对应位置是否为1，若有一个为0，则说明不存在，如果都为1，只能说明极有可能存在，因为有可能是其他key计算出来的。

所以，位数组越稀疏，hash后的值碰撞冲突的情况就越少，则正确率就会越大，反之就会越小。

## 布隆过滤器的其他应用
在爬虫系统中，需要对URL进行去重，已经爬过的网页就可以不用爬了，使用集合非常浪费空间，这时候可以考虑使用布隆过滤器。它可以大幅降低去重存储消耗。缺点是会使得爬虫系统错过少量页面。

布隆过滤器在NOSQL数据库领域使用的非常广泛，它可以显著降低数据库的IO请求数量。当用户来查询某个row时，可以先通过内存中的布隆过滤器过滤掉大量不存在的row请求，然后再去磁盘查询。

邮箱系统的垃圾邮件过滤功能也使用到布隆过滤器，所以会有某些正常的邮件被放进了垃圾邮件目录中，但是概率很低。


