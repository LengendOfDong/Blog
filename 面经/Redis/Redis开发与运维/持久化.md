# 持久化

## RDB

RDB持久化是把当前进程数据生成快照保存到硬盘的过程。

Redis内部存在自动触发RDB的持久化机制：

- 使用save相关配置，如“save m n”,表示m秒内数据集存在n次修改时，自动触发bgsave

- 如果从节点执行全量复制操作，主节点自动执行bgsave生成RDB文件并发送给从节点。

- 执行debug reload 命令重新加载Redis时，也会自动触发save操作。

- 默认情况下执行shutdown命令时，如果没有开启AOF持久化功能则自动执行bgsave

### RDB流程说明

1.执行bgsave命令，Redis父进程判断当前是否存在正在执行的子进程，如RDB/AOF子进程，如果存在bgsave命令直接返回

2.父进程执行fork操作创建子进程，fork操作过程中父进程会阻塞

3.父进程fork完成后，bgsave命令返回“Background saving started”信息并不再阻塞父进程，可以继续响应其他命令。

4.子进程创建RDB文件，根据父进程内存生成临时快照文件，完成后对原有文件进行原子替换。

5.进程发送信号给父进程表示完成，父进程更新统计信息。

### RDB的优缺点

#### RDB的优点：

- RDB是一个紧凑压缩的二进制文件，代表Redis在某个时间点上的数据快照，非常适合用于备份，全量复制等场景

- Redis加载RDB恢复数据远远快于AOF的方式。

#### RDB的缺点：

- RDB方式数据没办法做到实时持久化/秒级持久化，因为bgsave每次运行都要执行fork操作创建子进程，属于重量级操作，频繁执行成本过高。

- RDB文件使用特定二进制格式保存，Redis版本演进过程中有多个格式的RDB版本，存在老版本Redis服务无法兼容新版本RDB版本的问题。

## AOF

AOF（Append Only File）持久化：以独立日志的方式记录每次写命令，重启时再重新执行AOF文件中的命令达到恢复数据的目的。

AOF的主要作用是解决了数据持久化的实时性，目前已经是Redis持久化的主流方式。

### AOF流程说明

1.所有的写入命令会追加到aof_buf（缓冲区）中

2.AOF缓冲区根据对应的策略向硬盘做同步操作

3.随着AOF文件越来越大，需要定期对AOF文件进行重写

4.当Redis服务器重启时，可以加载AOF文件进行数据恢复。

1）命令写入:AOF命令写入的内容直接是文本协议格式

2）文件同步：Redis提供了多种AOF缓冲区同步文件策略。

| 可配置值     | 说明                                                                |
| -------- | ----------------------------------------------------------------- |
| always   | 命令写入aof_buf后调用系统fsync操作同步到AOF文件，fsync完成后线程返回                      |
| everysec | 命令写入aof_buf后调用系统write操作，write完成后线程返回，fsync同步文件操作由专门线程每秒调用一次       |
| no       | 命令写入aof_buf后调用系统write操作，不对AOF文件做fsync同步，同步硬盘操作由操作系统负责，通常同步周期最长30秒 |

系统调用write和fsync说明：

- write: 该操作会触发延迟写（delayed write) 机制，Linux在内核提供页缓冲区来提高硬盘IO性能

- fsync针对单个文件操作（比如AOF文件），做墙纸硬盘同步，fsync将阻塞直到写入硬盘完成后返回，保证了数据持久化。

3）重写机制

Redis引入AOF重写机制压缩文件体积，AOF文件重写会把Redis进程内的数据转化为写命令同步到新AOF文件的过程。

为何重写后的AOF文件会变小：

1.进程内已经超时的数据不再写入文件

2.旧的AOF文件含有无效的命令，重写使用进程内数据直接生成，新的AOF文件只保留最终数据的写入命令。

3.多条写命令可以合并为一个

AOF重写流程说明：

1.执行AOF重写请求

2.父进程执行fork创建子进程，开销等同于bgsave过程

3.1.主进程fork操作完成后，继续响应其他命令，所有修改命令依然写入AOF缓冲区并根据appendfsync策略同步到硬盘，保证原有的AOF机制正确性

3.2.由于fork操作运用写时复制技术，子进程只能共享fork操作时的内存数据。由于父进程依然响应命令，Redis使用“AOF重写缓冲区”保存这部分新数据，防止新AOF文件生成期间丢失这部分数据。

4.子进程根据内存快照，按照命令合并规则写入到新的AOF文件。

5.1.新AOF文件写入完成后，子进程发送信号给父进程，父进程更新统计信息。

5.2.父进程把AOF重写缓冲区的数据写入到新的AOF文件

5.3.使用新AOF文件替换老文件，完成AOF重写。

4）重启加载

AOF和RDB文件都可以用于服务器重启时的数据恢复。

5）文件校验

AOF文件可能存在结尾不完整的情况，Redis提供了aof-load-truncated配置来兼容这种情况，默认开启。


