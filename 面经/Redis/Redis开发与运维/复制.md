# 复制

## 拓扑

1.一主一从结构

一主一从结构是最简单的复制拓扑结构，用于主节点出现宕机时从节点提供故障转移支持。

2.一主多从结构

一主多从结构又称为星型拓扑结构，使得应用端可以利用多个从节点实现读写分离。

对于读占比较大的场景，可以把读命令发送到从节点来分担主节点压力。

3.树状主从结构

树状主从结构又称为树状拓扑结构，使得从节点不但可以复制主节点的数据，同时可以作为其他从节点的主节点继续向下层复制。通过引入复制中间层，可以有效降低主节点负载和需要传送给从节点的数据量。

## 原理

复制过程大致分为6个过程：

1.保存主节点信息

2.从节点内部通过每秒运行的定时任务维护复制相关逻辑，当定时任务发现存在新的主节点后，会尝试与该节点建立网络连接。

3.发送ping命令

发送ping命令的主要目的：

- 检测主从之间的网络套接字是否可用

- 检测主节点当前是否可以接受处理命令

如果没有收到主节点返回的pong回复或者超时，说明上面两种情况之一不满足，此时从节点会断开复制连接，定时任务会发起重连。

4.权限验证

这种情况需要主节点设置requirepass参数，需要密码验证，而从节点也需要配置masterauth参数才可以通过验证。

5.同步数据集

同步划分为两种情况： 全量复制和部分复制

6.命令持续复制

主节点会持续地把写命令发送给从命令，保证从节点数据一致性。



#### 全量复制

流程说明：

1.发送psync命令进行数据同步，由于是第一次进行复制，从节点没有复制偏移量和主节点的运行ID， 所以发送psync  ?  -1

2.主节点根据psync ? -1解析出当前为全量复制，回复+FULLRESYNC响应。

3.从节点接收主节点响应数据保存运行ID和偏移量offset。

4.主节点执行bgsave保存RDB文件到本地

5.主节点发送RDB文件给从节点，从节点把接收的RDB文件保存在本地并直接作为从节点的数据文件，接收完RDB后从节点打印相关日志。

6.对于从节点开始接收RDB快照到接收完成期间，主节点仍然响应读写命令，因此主节点会把这期间写命令数据保存在复制客户端缓冲区内，当从节点加载完RDB文件后，主节点再把缓冲区内的数据发送给从节点，保证主从之间数据一致性。

7.从节点接收完主节点传送过来的全部数据后会清空自身旧数据

8.从节点清空数据后开始加载RDB文件，对于较大的RDB稳健，这一步操作依然比较耗时。

9.从节点成功加载完RDB后，如果当前节点开启了AOF持久化功能，它会立刻做bgrewriteaof操作，为了保证全量复制后AOF持久化文件立刻可用。



#### 部分复制

部分复制主要是Redis针对全量复制的过高开销做出的一种优化措施，使用psync  runId   offset 命令实现。

流程说明：

1.当主从节点之间网络出现中断时，如果超过repl-timeout时间，主节点会认为从节点故障并中断复制连接。

2.主从连接中断期间主节点依然响应命令，但因复制连接中断命令无法发送给从节点，不过主节点内部存在的复制积压缓冲区，依然可以保存最近一段时间的写命令数据，默认最大缓存1MB。

3.当主从节点网络恢复后，从节点会再次连上主节点。

4.当主从连接恢复后，由于从节点之前保存了自身已复制的偏移量和主节点的运行ID。因此会把他们当做psync的参数发送给主节点，要求进行部分复制操作。

5.主节点接到psync命令后首先核对参数runId是否与自身一致，如果一致，说明之前复制的是当前主节点；之后根据参数offset在自身复制积压缓冲区查找，如果偏移量之后的数据存在缓冲区中，则对从节点发送+CONTINUE响应，表示可以进行部分复制。

6.主节点根据偏移量把复制积压缓冲区里的数据发送给从节点，保证主从复制进入正常状态。






