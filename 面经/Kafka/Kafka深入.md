## 集群成员关系
在broker启动时，它通过创建临时节点把自己的id注册到zookeeper，kafka组件订阅Zookeeper的/brokers/ids路径（broker在Zookeeper上的注册路径），当有broker加入集群或退出集群时，这些组件就可以获得通知。

控制器是一个broker，除了具有一般broker的功能之外，还负责分区首领的选举。集群里第一个启动的broker通过在zookeeper里创建一个临时节点/controller让自己成为控制器。其他broker在控制器节点上增加watch对象，这样就可以得到控制器的通知。

每个新选出的控制器通过zookeeper的条件递增操作获得一个全新的，数值更大的controller epoch。其他broker在知道当前controller epoch后，如果收到由控制器发出的包含旧controller epoch的消息就会忽略他们。

## 复制
复制功能是Kafka架构的核心，复制之所以这么关键，在于如果有个别节点失效，仍然能够保证Kafka的可用性和持久性。

Kafka使用主题来组织数据，每个主题被分为若干个分区，每个分区有多个副本，那些副本被保存在broker上，每个broker可以保存成百上千个属于不同主题和分区的副本。

首领副本：每个分区都有一个首领副本，为了保证一致性，所有生产者请求和消费者请求都会经过这个副本。

跟随者副本：首领以外的副本都是跟随者副本。跟随者副本不处理来自客户端的请求，它们唯一的任务就是从首领那里复制消息，保持与首领一致的状态。如果首领发生崩溃，其中的一个跟随者会被提升为新首领。

首领的另一个任务是搞清楚哪个跟随者的状态与自己是一致的。如果跟随者在10s内没有请求任何消息，或者虽然在请求消息，但在10s内没有请求最新的数据，那么它就会被认为是不同步的。如果一个副本无法与首领保持一致，那么在首领失效时，就不可能被选举为新首领。

相反，持续请求得到的最新消息副本被称为同步的副本。在首领发生失效时，只有同步副本才有可能被选为新首领。

## 文件格式
保存在磁盘上的数据格式与从生产者发送过来或者发送给消费者的消息格式是一样的。因为使用了相同的消息格式进行磁盘存储和网络传输，Kafka可以使用零复制技术给消费者发送消息，同时避免了对生产者已经压缩过的消息进行解压和再压缩。

