# zookeeper基本概念
- 数据节点：zk数据模型中的最小数据单元，数据模型是一棵树，由斜杠（/)分割的路径名称唯一标识，数据节点可以存储数据内容以及一系列属性信息，同时还可以挂载子节点，构成一个层次化的命名空间。
- 会话（Session)：zk客户端与zk服务端之间的会话中，在zk中，会话是通过客户端与服务端之间的一个TCP长连接来实现的。通过这个长连接，客户端能够使用心跳检测来与服务端保持有效的会话，也能像服务端发送请求与接受响应，还可以接收服务端的Watcher事件通知。Session的SessionTimeOUt，是会话的超时时间。如果在这时间内，客户端未与服务端之间发生任何沟通（心跳或者请求），服务器端会清除该session数据，客户端的TCP长连接将不可用，这种情况下，客户端需要重新实例化一个Zookeeper对象。
- 事务与ZXID：事务是指能够改变zookeeper服务器状态的操作，一般包括数据节点的创建于删除，数据节点内容更新和客户端会话创建于失效等操作。对于每个事务请求，zk都会为其分配一个全局唯一的事务ID，即ZXID，是一个64位的数字，高32位表示该事务发生的集群选举周期（集群每发生一次leader选举，值加1），低32位表示该事务在当前选择周期内的递增次序（leader每处理一个事务请求，值加1，发生一次leader选举，低32位要清0），可以看到，这64位数字是不会重复的，可以结合高32位与低32位分析出每个leader任期内，进行了多少次事务请求。
- 事务日志：所有事务操作都是需要记录道日志文件中的，可通过dataLogDir配置文件目录，文件是以写入的第一条事务zxid位后缀，方便后续的定位查找。zk会采取“磁盘空间预分配”的策略，来避免磁盘Seek频率，提升zk服务器对事务请求的响应能力。默认设置下，每次事务日志写入操作都将会实时刷入磁盘，也可以设置成非实时（写到内存文件流，定时批量写入磁盘），但那样断电时会带来丢失数据的风险。
- 数据快照：数据快照时zk数据存储中另一个非常核心的运行机制。数据快照用来记录zk服务器上某一时刻的全量内存数据内容，并将其写入道指定的磁盘文件中，可通过dataDir配置文件目录。可配置参数snapCount,设置两次快照之间的事务操作个数，zk节点记录完事务日志时，会统计判断是否需要做数据快照（距离上次快照，事务操作次数等于snapCount/2 ~ snapCount中的某个值，会触发快照生成操作，随机值是为了避免所有节点同时生成快照，导致集群运行缓慢。
- 过半：所谓“过半”是指大于集群机器数量的一半，即大于或等于（n/2+1），此处的“集群机器数量”不包括observer角色节点。leader广播一个事务消息后，当收到半数以上的ack信息时，就认为集群中所有节点都收到了消息，然后leader就不需要再等待剩余节点的ack，直接广播commit消息，提交事务。选举中的投票提议及数据同步时，也是如此，leader不需要等到所有learner节点的反馈，只要收到过半的反馈就可进行下一步操作。

# 数据模型
zk维护的数据主要有：客户端的会话状态，以及数据节点信息。zk在内存中构造了一个DataTree的数据结构
