# zookeeper基本概念
- 数据节点：zk数据模型中的最小数据单元，数据模型是一棵树，由斜杠（/)分割的路径名称唯一标识，数据节点可以存储数据内容以及一系列属性信息，同时还可以挂载子节点，构成一个层次化的命名空间。
- 会话（Session)：zk客户端与zk服务端之间的会话中，在zk中，会话是通过客户端与服务端之间的一个TCP长连接来实现的。通过这个长连接，客户端能够使用心跳检测来与服务端保持有效的会话，也能像服务端发送请求与接受响应，还可以接收服务端的Watcher事件通知。Session的SessionTimeOUt，是会话的超时时间。如果在这时间内，客户端未与服务端之间发生任何沟通（心跳或者请求），服务器端会清除该session数据，客户端的TCP长连接将不可用，这种情况下，客户端需要重新实例化一个Zookeeper对象。
- 事务与ZXID：事务是指能够改变zookeeper服务器状态的操作，一般包括数据节点的创建于删除，数据节点内容更新和客户端会话创建于失效等操作。对于每个事务请求，zk都会为其分配一个全局唯一的事务ID，即ZXID，是一个64位的数字，高32位表示该事务发生的集群选举周期（集群每发生一次leader选举，值加1），低32位表示该事务在当前选择周期内的递增次序（leader每处理一个事务请求，值加1，发生一次leader选举，低32位要清0），可以看到，这64位数字是不会重复的，可以结合高32位与低32位分析出每个leader任期内，进行了多少次事务请求。
- 事务日志：所有事务操作都是需要记录道日志文件中的，可通过dataLogDir配置文件目录，文件是以写入的第一条事务zxid位后缀，方便后续的定位查找。zk会采取“磁盘空间预分配”的策略，来避免磁盘Seek频率，提升zk服务器对事务请求的响应能力。默认设置下，每次事务日志写入操作都将会实时刷入磁盘，也可以设置成非实时（写到内存文件流，定时批量写入磁盘），但那样断电时会带来丢失数据的风险。
- 数据快照：数据快照时zk数据存储中另一个非常核心的运行机制。数据快照用来记录zk服务器上某一时刻的全量内存数据内容，并将其写入道指定的磁盘文件中，可通过dataDir配置文件目录。可配置参数snapCount,设置两次快照之间的事务操作个数，zk节点记录完事务日志时，会统计判断是否需要做数据快照（距离上次快照，事务操作次数等于snapCount/2 ~ snapCount中的某个值，会触发快照生成操作，随机值是为了避免所有节点同时生成快照，导致集群运行缓慢。
- 过半：所谓“过半”是指大于集群机器数量的一半，即大于或等于（n/2+1），此处的“集群机器数量”不包括observer角色节点。leader广播一个事务消息后，当收到半数以上的ack信息时，就认为集群中所有节点都收到了消息，然后leader就不需要再等待剩余节点的ack，直接广播commit消息，提交事务。选举中的投票提议及数据同步时，也是如此，leader不需要等到所有learner节点的反馈，只要收到过半的反馈就可进行下一步操作。

# 数据模型
zk维护的数据主要有：客户端的会话状态，以及数据节点信息。zk在内存中构造了一个DataTree的数据结构，维护着path到dataNode的映射，以及dataNode间的树状层级关系。为了提高读取性能，集群中每个服务节点都是将数据全量存储在内存中。可见，zk最适于读多写少且轻量级数据（默认设置下单个dataNode限制为1MB大小）的应用场景。数据仅存储在内存是很不安全的，zk采用事务日志文件及快照文件的方案来落盘数据，保障数据在不丢失的情况下能快速恢复。

# 集群架构
zk集群由多个节点组成，其中有且仅有一个leader，处理所有事务请求，follower以及observer统称Learner。

learner需要同步leader的数据，follower还参与选举及事务决策过程。zk客户端会打散配置文件中的serverAddress顺序并随机组成新的list,然后循环按序取一个服务器地址进行连接，直到成功。

follower及observer会将事务请求转交给leader处理。

要搭建一个高可用的zk集群，我们首先需要确定好集群规模。一般我们将节点（指leader及follower节点，不包括observer节点）个数设置为 2*n+1 ，n为可容忍宕机的个数。 zk使用“过半”设计原则，很好地解决了单点问题，提升了集群容灾能力。但是zk的集群伸缩不是很灵活，集群中所有机器ip及port都是事先配置在每个服务的zoo.cfg 文件里的。如果要往集群增加一个follower节点，首先需要更改所有机器的zoo.cfg，然后逐个重启。

集群模式下，单个zk服务节点启动时的工作流程大致如下：
- 统一由QuorumPeerMain作为启动类，加载解析zoo.cfg配置文件；
- 初始化核心类：ServerCnxnFactory（IO操作）、FileTxnSnapLog（事务日志及快照文件操作）、QuorumPeer实例（代表zk集群中的一台机器）、ZKDatabase（内存数据库）等；
- 加载本地快照文件及事务日志，恢复内存数据；
- 完成leader选举，节点间通过一系列投票，选举产生最合适的机器成为leader，同时其余机器成为follower或是observer。关于选举算法，就是集群中哪个机器处理的数据越新（通过ZXID来比较，ZXID越大，数据越新），其越有可能被选中；
- 完成leader与learner间的数据同步：集群中节点角色确定后，leader会重新加载本地快照及日志文件，以此作为基准数据，再结合各个learner的本地提交数据，leader再确定需要给具体learner回滚哪些数据及同步哪些数据；
- 当leader收到过半的learner完成数据同步的ACK，集群开始正常工作，可以接收并处理客户端请求，在此之前集群不可用。

# zookeeper一致性协议
