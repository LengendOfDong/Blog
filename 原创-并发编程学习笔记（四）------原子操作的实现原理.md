# 原创：并发编程学习笔记（四）------原子操作的实现原理

注明：<br/>
参考书作者：方腾飞 魏鹏 程晓明<br/>
参考书目：《Java 并发编程的艺术》

# 原子操作的实现原理

## 处理器如何实现原子操作

处理器提供总线锁定和缓存锁定两个机制来保证复杂内存操作的原子性。<br/>
（1）使用总线锁保证原子性<br/>
所谓总线锁就是使用处理器提供的一个Lock#信号，当一个处理器在总线上输出此信号时，其他处理器的请求将被阻塞住，那么该处理器可以独占共享内存。<br/>
（2）使用缓存锁保证原子性<br/>
在同一时刻，只需保证对某个内存地址的操作是原子性的即可，但总线锁定把CPU和内存之间的通信锁住了，这使得锁定期间，其他处理器不能操作其他内存地址的数据，所以总线锁定的开销比较大，故用缓存锁代替总线锁进行优化。<br/>
使用缓存锁定，当执行锁操作写回到内存中时修改内存中内存地址，并通过缓存一致性阻止同时修改由两个以上处理器缓存的内存区域数据，其他处理器的缓存行会无效。

## JAVA如何实现原子操作

在Java中可以通过锁和循环CAS的方式来实现原子操作。<br/>
（1）使用循环CAS实现原子操作<br/>
JVM中的CAS操作正是利用了处理器提供的CMPXCHG指令实现的，该指令是通过缓存锁定将指令操作的内存区域加锁来实现原子操作。<br/>
从Java1.5开始，JDK的并发包里提供了一些类来支持原子操作，如AtomicBoolean,AtomicInteger,AtomicLong,可以通过这些类的api来实现自增1，自减1。<br/>
（2）CAS实现原子操作的三大问题

(3)使用锁机制实现原子操作<br/>
JVM内部实现了很多种锁机制，有偏向锁，轻量级锁和互斥锁。<br/>
除了偏向锁，当一个线程进入同步块的时候使用循环CAS的方式来获取锁，当它退出同步块的时候使用循环CAS释放锁。
